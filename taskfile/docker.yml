version: "3"

tasks:
  clean:
    desc: "Remove unused docker containers"
    ignore_error: true
    cmds:
      - |
        {{.DOCKER_SUDO}} docker rm -v $({{.DOCKER_SUDO}} docker ps -a --filter status=exited -q) 2>/dev/null || true

  wavs-cli:
    desc: "Run wavs-cli in Docker"
    vars:
      ARGS: '{{.CLI_ARGS}}'
    cmds:
      - |
        {{.DOCKER_SUDO}} docker run --rm --network host \
        $(test -f .env && echo "--env-file ./.env") \
        -v $(pwd):/data {{.DOCKER_IMAGE}} wavs-cli {{.ARGS}}

  middleware:
    desc: "Run wavs-middleware in Docker"
    vars:
      COMMAND: '{{.COMMAND}}'
    cmds:
      - |
        {{.DOCKER_SUDO}} docker run --rm --network host --env-file .env \
        $(if {{.WAVS_SERVICE_MANAGER_ADDRESS}}; then echo "-e WAVS_SERVICE_MANAGER_ADDRESS={{.WAVS_SERVICE_MANAGER_ADDRESS}}"; fi) \
        $(if {{.OPERATOR_KEY}}; then echo "-e OPERATOR_KEY={{.OPERATOR_KEY}}"; fi) \
        $(if {{.WAVS_SIGNING_KEY}}; then echo "-e WAVS_SIGNING_KEY={{.WAVS_SIGNING_KEY}}"; fi) \
        $(if {{.WAVS_DELEGATE_AMOUNT}}; then echo "-e WAVS_DELEGATE_AMOUNT={{.WAVS_DELEGATE_AMOUNT}}"; fi) \
        -v ./.nodes:/root/.nodes {{.MIDDLEWARE_DOCKER_IMAGE}} {{.COMMAND}}
